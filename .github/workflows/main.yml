name: Update README with Latest Branch Commits

on:
  push:
    branches:
      - '**'  # Tüm branch'lerdeki push işlemlerini tetikle
  workflow_dispatch:  # Manuel olarak tetiklemek için

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch All Branches
        run: git fetch --all

      - name: Generate Branch Commit Info
        run: |
          echo "### Project Goal" > README.md
          echo "" >> README.md
          echo "- Main : Create a Wishlist" >> README.md
          echo "- DBC : Day of Word like a diary. " >> README.md
          echo "" >> README.md
          echo "### Branches" >> README.md
          echo "" >> README.md

          # Tüm branch'leri dolaş ve commit bilgilerini al
          for branch in $(git branch -r | grep -v 'HEAD\|main'); do
            branch_name=${branch#origin/}
            echo "- $branch_name" >> README.md

            # En son 3 commit'i al ve açıklamaları kontrol et
            git log $branch -3 --pretty=format:"  - %h - %s%n%b" | awk '
              BEGIN { RS = ""; FS = "\n" }
              {
                print "- " $1
                if (NF > 1) {
                  for (i = 2; i <= NF; i++) {
                    print "        - " $i
                  }
                } else {
                  print "        - No description provided."
                }
              }
            ' >> README.md
            echo "" >> README.md
          done

          # Main branch'i özel olarak ekle
          echo "- Main" >> README.md
          git log main -3 --pretty=format:"  - %h - %s%n%b" | awk '
            BEGIN { RS = ""; FS = "\n" }
            {
              print "  - " $1
              if (NF > 1) {
                for (i = 2; i <= NF; i++) {
                  print "        - " $i
                }
              } else {
                print "        - No description provided."
              }
            }
          ' >> README.md
          echo "" >> README.md
        shell: bash

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "actions@github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git add README.md
          git commit -m "Update README with latest branch commits" || echo "No changes to commit"
          git push origin main
